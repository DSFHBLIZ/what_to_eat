(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[35],{5354:function(e,s,r){Promise.resolve().then(r.bind(r,7463))},998:function(e,s,r){"use strict";r.d(s,{Z:function(){return d}});var t=r(208);/**
 * @license lucide-react v0.484.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let c=e=>e.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase(),n=e=>e.replace(/^([A-Z])|[\s-_]+(\w)/g,(e,s,r)=>r?r.toUpperCase():s.toLowerCase()),i=e=>{let s=n(e);return s.charAt(0).toUpperCase()+s.slice(1)},a=function(){for(var e=arguments.length,s=Array(e),r=0;r<e;r++)s[r]=arguments[r];return s.filter((e,s,r)=>!!e&&""!==e.trim()&&r.indexOf(e)===s).join(" ").trim()};/**
 * @license lucide-react v0.484.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */var l={xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"};/**
 * @license lucide-react v0.484.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let o=(0,t.forwardRef)((e,s)=>{let{color:r="currentColor",size:c=24,strokeWidth:n=2,absoluteStrokeWidth:i,className:o="",children:d,iconNode:m,...u}=e;return(0,t.createElement)("svg",{ref:s,...l,width:c,height:c,stroke:r,strokeWidth:i?24*Number(n)/Number(c):n,className:a("lucide",o),...u},[...m.map(e=>{let[s,r]=e;return(0,t.createElement)(s,r)}),...Array.isArray(d)?d:[d]])}),d=(e,s)=>{let r=(0,t.forwardRef)((r,n)=>{let{className:l,...d}=r;return(0,t.createElement)(o,{ref:n,iconNode:s,className:a("lucide-".concat(c(i(e))),"lucide-".concat(e),l),...d})});return r.displayName=i(e),r}},979:function(e,s,r){"use strict";r.d(s,{Z:function(){return t}});let t=(0,r(998).Z)("clock",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["polyline",{points:"12 6 12 12 16 14",key:"68esgv"}]])},9821:function(e,s,r){"use strict";r.d(s,{Z:function(){return t}});let t=(0,r(998).Z)("database",[["ellipse",{cx:"12",cy:"5",rx:"9",ry:"3",key:"msslwz"}],["path",{d:"M3 5V19A9 3 0 0 0 21 19V5",key:"1wlel7"}],["path",{d:"M3 12A9 3 0 0 0 21 12",key:"mv7ke4"}]])},7463:function(e,s,r){"use strict";let t;r.r(s),r.d(s,{default:function(){return S}});var c=r(984),n=r(208),i=r(346),a=r(979),l=r(998);let o=(0,l.Z)("refresh-cw",[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8",key:"v9h5vc"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16",key:"3uifl3"}],["path",{d:"M8 16H3v5",key:"1cv678"}]]),d=(0,l.Z)("circle-check-big",[["path",{d:"M21.801 10A10 10 0 1 1 17 3.335",key:"yps3ct"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]]),m=(0,l.Z)("circle-x",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m15 9-6 6",key:"1uzhvr"}],["path",{d:"m9 9 6 6",key:"z0biqf"}]]),u=(0,l.Z)("circle-alert",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["line",{x1:"12",x2:"12",y1:"8",y2:"12",key:"1pkeuh"}],["line",{x1:"12",x2:"12.01",y1:"16",y2:"16",key:"4dfq90"}]]),x=(0,l.Z)("chevron-left",[["path",{d:"m15 18-6-6 6-6",key:"1wnfg3"}]]);var p=r(9821);let g=(0,l.Z)("circle-play",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["polygon",{points:"10 8 16 12 10 16 10 8",key:"1cimsy"}]]);var h=r(2436),N=r(2022);let y=N.env.NEXT_PUBLIC_SUPABASE_URL||"",f=N.env.NEXT_PUBLIC_SUPABASE_ANON_KEY||"";t=(0,h.eI)(y,f);let E=[{name:"idx_recipe_name",description:"菜谱名称文本搜索索引",tableName:"CHrecipes",sql:'CREATE INDEX IF NOT EXISTS idx_recipe_name ON "CHrecipes" USING gin (to_tsvector(\'chinese\', "name"));'},{name:"idx_recipe_description",description:"菜谱描述文本搜索索引",tableName:"CHrecipes",sql:'CREATE INDEX IF NOT EXISTS idx_recipe_description ON "CHrecipes" USING gin (to_tsvector(\'chinese\', "description"));'},{name:"idx_recipe_ingredients",description:"食材JSONB索引",tableName:"CHrecipes",sql:'CREATE INDEX IF NOT EXISTS idx_recipe_ingredients ON "CHrecipes" USING gin ("ingredients");'},{name:"idx_recipe_seasonings",description:"调料JSONB索引",tableName:"CHrecipes",sql:'CREATE INDEX IF NOT EXISTS idx_recipe_seasonings ON "CHrecipes" USING gin ("seasonings");'},{name:"idx_recipe_flavors",description:"口味特点索引",tableName:"CHrecipes",sql:'CREATE INDEX IF NOT EXISTS idx_recipe_flavors ON "CHrecipes" USING gin ("flavors");'},{name:"idx_recipe_cuisine",description:"菜系索引",tableName:"CHrecipes",sql:'CREATE INDEX IF NOT EXISTS idx_recipe_cuisine ON "CHrecipes" ("cuisine");'},{name:"idx_recipe_difficulty",description:"难度索引",tableName:"CHrecipes",sql:'CREATE INDEX IF NOT EXISTS idx_recipe_difficulty ON "CHrecipes" ("difficulty");'},{name:"idx_recipe_cookingTime",description:"烹饪时间索引",tableName:"CHrecipes",sql:'CREATE INDEX IF NOT EXISTS idx_recipe_cookingTime ON "CHrecipes" ("cookingTime");'},{name:"idx_recipe_cookingMethods",description:"烹饪方法索引",tableName:"CHrecipes",sql:'CREATE INDEX IF NOT EXISTS idx_recipe_cookingMethods ON "CHrecipes" USING gin ("cookingMethods");'},{name:"idx_recipe_dietaryRestrictions",description:"饮食限制索引",tableName:"CHrecipes",sql:'CREATE INDEX IF NOT EXISTS idx_recipe_dietaryRestrictions ON "CHrecipes" USING gin ("dietaryRestrictions");'}];async function b(){console.log("开始创建所有索引...");let e=!1,s=[];for(let r of E){console.log("创建索引: ".concat(r.name));let c={...r,runStatus:"running"};s.push(c);try{let{error:s}=await t.rpc("run_sql",{sql_query:r.sql});s?(console.error("创建索引 ".concat(r.name," 失败:"),s.message),c.runStatus="error",c.errorMessage=s.message,e=!0):(console.log("索引 ".concat(r.name," 创建成功")),c.runStatus="success")}catch(s){console.error("创建索引 ".concat(r.name," 发生错误:"),s),c.runStatus="error",c.errorMessage=s instanceof Error?s.message:String(s),e=!0}}return{success:!e,results:s,error:e?"部分索引创建失败，请查看详情":void 0}}async function _(e){let s=E.find(s=>s.name===e);if(!s)return{success:!1,error:"索引 ".concat(e," 未找到定义")};console.log("创建索引: ".concat(s.name));try{let{error:e}=await t.rpc("run_sql",{sql_query:s.sql});if(e)return console.error("创建索引 ".concat(s.name," 失败:"),e.message),{success:!1,error:e.message};return console.log("索引 ".concat(s.name," 创建成功")),{success:!0}}catch(e){return console.error("创建索引 ".concat(s.name," 发生错误:"),e),{success:!1,error:e instanceof Error?e.message:String(e)}}}async function j(){console.log("检查索引状态...");try{let{data:e,error:s}=await t.rpc("run_sql",{sql_query:"\n      SELECT\n        i.indexname AS index_name,\n        i.indexdef AS index_definition\n      FROM\n        pg_indexes i\n      WHERE\n        i.schemaname = 'public' AND\n        i.tablename = 'CHrecipes';\n    "});if(s)return console.error("检查索引状态失败:",s.message),{success:!1,error:s.message};let r=e.map(e=>e.index_name),c=E.map(e=>({name:e.name,exists:r.includes(e.name)}));return console.log("索引状态检查完成"),{success:!0,indexes:c}}catch(e){return console.error("检查索引状态发生错误:",e),{success:!1,error:e instanceof Error?e.message:String(e)}}}async function v(){console.log("开始执行ANALYZE命令...");try{let{error:e}=await t.rpc("run_sql",{sql_query:'ANALYZE "CHrecipes";'});if(e)return console.error("执行ANALYZE命令失败:",e.message),{success:!1,error:e.message};return console.log("ANALYZE命令执行成功"),{success:!0}}catch(e){return console.error("执行ANALYZE命令发生错误:",e),{success:!1,error:e instanceof Error?e.message:String(e)}}}function S(){let[e,s]=(0,n.useState)(E.map(e=>({name:e.name,description:e.description,status:"pending"}))),[r,t]=(0,n.useState)("pending"),[l,h]=(0,n.useState)(null),[N,y]=(0,n.useState)([]),[f,S]=(0,n.useState)(!1),[k,C]=(0,n.useState)([]),[A,w]=(0,n.useState)(!1),I=e=>{let s=new Date().toLocaleTimeString();y(r=>[...r,"[".concat(s,"] ").concat(e)])},T=async()=>{w(!0),I("正在检查数据库索引状态...");try{let r=await j();if(r.success&&r.indexes){C(r.indexes),I("索引检查完成，共 ".concat(r.indexes.length," 个索引"));let t=[...e];r.indexes.forEach(e=>{let{name:s,exists:r}=e,c=t.findIndex(e=>e.name===s);-1!==c&&(t[c].status=r?"success":"pending")}),s(t)}else I("索引检查失败: ".concat(r.error||"未知错误"))}catch(e){I("索引检查发生错误: ".concat(e instanceof Error?e.message:String(e)))}finally{w(!1)}},q=async r=>{let t=e.findIndex(e=>e.name===r);if(-1===t)return;let c=[...e];c[t].status="running",s(c),I("开始创建索引: ".concat(r));try{let e=await _(r),n=[...c];e.success?(n[t].status="success",I("索引 ".concat(r," 创建成功"))):(n[t].status="error",n[t].error=e.error,I("索引 ".concat(r," 创建失败: ").concat(e.error))),s(n)}catch(n){let e=[...c];e[t].status="error",e[t].error=n instanceof Error?n.message:String(n),s(e),I("创建索引 ".concat(r," 时发生错误: ").concat(e[t].error))}},O=async()=>{S(!0),s(e.map(e=>({...e,status:"running"}))),I("开始创建所有索引...");try{let e=await b(),r=e.results.map((e,s)=>({name:e.name,description:e.description,status:e.runStatus||"pending",error:e.errorMessage}));s(r),e.success?I("所有索引创建成功"):I("部分索引创建失败: ".concat(e.error||"未知错误"))}catch(e){I("创建索引时发生错误: ".concat(e instanceof Error?e.message:String(e)))}finally{S(!1)}},Z=async()=>{t("running"),h(null),I("开始执行ANALYZE命令优化数据库统计信息...");try{let e=await v();e.success?(t("success"),I("ANALYZE命令执行成功")):(t("error"),h(e.error||null),I("ANALYZE命令执行失败: ".concat(e.error)))}catch(s){t("error");let e=s instanceof Error?s.message:String(s);h(e),I("执行ANALYZE命令时发生错误: ".concat(e))}},H=e=>{switch(e){case"pending":return(0,c.jsx)(a.Z,{size:18,className:"text-gray-400"});case"running":return(0,c.jsx)(o,{size:18,className:"text-blue-500 animate-spin"});case"success":return(0,c.jsx)(d,{size:18,className:"text-green-500"});case"error":return(0,c.jsx)(m,{size:18,className:"text-red-500"});default:return(0,c.jsx)(u,{size:18,className:"text-gray-400"})}};return(0,n.useEffect)(()=>{T()},[]),(0,c.jsxs)("div",{className:"container mx-auto px-4 py-8 max-w-6xl",children:[(0,c.jsx)("div",{className:"flex items-center mb-6",children:(0,c.jsxs)(i.default,{href:"/admin",className:"flex items-center text-gray-600 hover:text-gray-900",children:[(0,c.jsx)(x,{size:20,className:"mr-1"}),(0,c.jsx)("span",{children:"返回管理面板"})]})}),(0,c.jsxs)("div",{className:"flex items-center mb-6",children:[(0,c.jsx)(p.Z,{size:24,className:"mr-2 text-blue-600"}),(0,c.jsx)("h1",{className:"text-2xl font-bold",children:"数据库优化"})]}),(0,c.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[(0,c.jsx)("div",{className:"lg:col-span-2",children:(0,c.jsxs)("div",{className:"bg-white rounded-lg shadow-md p-6",children:[(0,c.jsxs)("div",{className:"flex justify-between items-center mb-4",children:[(0,c.jsx)("h2",{className:"text-lg font-semibold",children:"索引优化任务"}),(0,c.jsxs)("div",{className:"flex gap-2",children:[(0,c.jsxs)("button",{onClick:T,disabled:A,className:"px-3 py-1.5 bg-gray-100 hover:bg-gray-200 rounded-md text-sm font-medium flex items-center disabled:opacity-50",children:[(0,c.jsx)(o,{size:16,className:"mr-1 ".concat(A?"animate-spin":"")}),"检查状态"]}),(0,c.jsxs)("button",{onClick:O,disabled:f,className:"px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded-md text-sm font-medium flex items-center disabled:opacity-50",children:[(0,c.jsx)(g,{size:16,className:"mr-1"}),"执行全部"]})]})]}),(0,c.jsx)("div",{className:"overflow-hidden rounded-md border border-gray-200",children:(0,c.jsxs)("table",{className:"min-w-full divide-y divide-gray-200",children:[(0,c.jsx)("thead",{className:"bg-gray-50",children:(0,c.jsxs)("tr",{children:[(0,c.jsx)("th",{scope:"col",className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"索引名称"}),(0,c.jsx)("th",{scope:"col",className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"描述"}),(0,c.jsx)("th",{scope:"col",className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"状态"}),(0,c.jsx)("th",{scope:"col",className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"操作"})]})}),(0,c.jsx)("tbody",{className:"bg-white divide-y divide-gray-200",children:e.map(e=>(0,c.jsxs)("tr",{children:[(0,c.jsx)("td",{className:"px-4 py-3 text-sm text-gray-900 font-mono",children:e.name}),(0,c.jsx)("td",{className:"px-4 py-3 text-sm text-gray-600",children:e.description}),(0,c.jsx)("td",{className:"px-4 py-3 text-sm",children:(0,c.jsxs)("div",{className:"flex items-center",children:[H(e.status),(0,c.jsxs)("span",{className:"ml-2",children:["pending"===e.status&&"待执行","running"===e.status&&"执行中","success"===e.status&&"已完成","error"===e.status&&"失败"]})]})}),(0,c.jsxs)("td",{className:"px-4 py-3 text-sm",children:[(0,c.jsx)("button",{onClick:()=>q(e.name),disabled:"running"===e.status||f,className:"px-2 py-1 bg-blue-50 hover:bg-blue-100 text-blue-600 rounded-md text-xs font-medium disabled:opacity-50",children:"success"===e.status?"重新创建":"执行"}),e.error&&(0,c.jsxs)("div",{className:"mt-1 text-xs text-red-500 truncate max-w-xs",title:e.error,children:[e.error.substring(0,50),e.error.length>50?"...":""]})]})]},e.name))})]})}),(0,c.jsxs)("div",{className:"mt-6",children:[(0,c.jsx)("h3",{className:"text-md font-semibold mb-3",children:"其他优化任务"}),(0,c.jsxs)("div",{className:"bg-gray-50 rounded-md p-4 flex items-center justify-between",children:[(0,c.jsxs)("div",{children:[(0,c.jsx)("div",{className:"font-medium",children:"更新数据库统计信息 (ANALYZE)"}),(0,c.jsx)("div",{className:"text-sm text-gray-600",children:"优化查询计划，提高查询效率"})]}),(0,c.jsxs)("div",{className:"flex items-center",children:[H(r),(0,c.jsx)("button",{onClick:Z,disabled:"running"===r,className:"ml-4 px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded-md text-sm font-medium disabled:opacity-50",children:"执行"})]})]}),l&&(0,c.jsxs)("div",{className:"mt-2 text-sm text-red-500",children:["错误: ",l]})]})]})}),(0,c.jsx)("div",{className:"lg:col-span-1",children:(0,c.jsxs)("div",{className:"bg-gray-900 rounded-lg shadow-md h-full",children:[(0,c.jsxs)("div",{className:"px-4 py-3 border-b border-gray-800 flex justify-between items-center",children:[(0,c.jsx)("h3",{className:"text-gray-200 font-mono text-sm",children:"执行日志"}),(0,c.jsx)("button",{onClick:()=>y([]),className:"text-gray-400 hover:text-gray-200 text-xs",children:"清空"})]}),(0,c.jsx)("div",{className:"p-4 font-mono text-xs text-gray-300 h-[600px] overflow-y-auto",children:0===N.length?(0,c.jsx)("div",{className:"text-gray-500 italic",children:"暂无日志输出"}):N.map((e,s)=>(0,c.jsx)("div",{className:"mb-1",children:e},s))})]})})]})]})}}},function(e){e.O(0,[346,410,115,69,744],function(){return e(e.s=5354)}),_N_E=e.O()}]);