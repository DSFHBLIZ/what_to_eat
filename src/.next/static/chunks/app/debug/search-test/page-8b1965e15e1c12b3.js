(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[534],{2027:function(e,r,t){Promise.resolve().then(t.bind(t,6988))},6988:function(e,r,t){"use strict";t.r(r),t.d(r,{default:function(){return s}});var n=t(984),o=t(208),a=t(2128);function s(){let[e,r]=(0,o.useState)(""),[t,s]=(0,o.useState)([]),[c,l]=(0,o.useState)(!1),[i,m]=(0,o.useState)(null);return(0,o.useEffect)(()=>{let r=setTimeout(async()=>{if(!e.trim()){s([]);return}l(!0),m(null);try{let r=await (0,a.rf)(e);s(r)}catch(e){console.error("获取建议时出错:",e),m("获取建议失败")}finally{l(!1)}},300);return()=>clearTimeout(r)},[e]),(0,n.jsxs)("div",{className:"p-8 max-w-4xl mx-auto",children:[(0,n.jsx)("h1",{className:"text-2xl font-bold mb-6",children:"搜索推荐测试"}),(0,n.jsxs)("div",{className:"mb-6",children:[(0,n.jsx)("label",{htmlFor:"search",className:"block mb-2 text-sm font-medium",children:"搜索关键词"}),(0,n.jsx)("input",{id:"search",type:"text",value:e,onChange:e=>r(e.target.value),placeholder:"输入关键词...",className:"w-full p-3 border border-gray-300 rounded-lg"})]}),c&&(0,n.jsx)("p",{className:"text-gray-500",children:"加载中..."}),i&&(0,n.jsx)("p",{className:"text-red-500",children:i}),!c&&t.length>0&&(0,n.jsxs)("div",{className:"mt-4",children:[(0,n.jsx)("h2",{className:"text-lg font-semibold mb-2",children:"搜索建议:"}),(0,n.jsx)("ul",{className:"border rounded-lg overflow-hidden",children:t.map((e,t)=>(0,n.jsx)("li",{className:"p-3 border-b last:border-b-0 hover:bg-gray-50 cursor-pointer",onClick:()=>r(e),children:e},t))})]}),!c&&e&&0===t.length&&(0,n.jsx)("p",{className:"text-gray-500",children:"没有找到相关建议"}),(0,n.jsxs)("div",{className:"mt-8 p-4 bg-gray-50 rounded-lg",children:[(0,n.jsx)("h2",{className:"text-lg font-semibold mb-2",children:"调试信息"}),(0,n.jsx)("pre",{className:"text-xs bg-gray-100 p-3 rounded overflow-auto max-h-[300px]",children:JSON.stringify({query:e,suggestions:t,loading:c,error:i},null,2)})]})]})}},2128:function(e,r,t){"use strict";let n;t.d(r,{rf:function(){return l},xx:function(){return i}});var o=t(2436),a=t(2022);let s=a.env.NEXT_PUBLIC_SUPABASE_URL||"",c=a.env.NEXT_PUBLIC_SUPABASE_ANON_KEY||"";async function l(e){try{if(!e||e.trim().length<1)return[];let r=e.trim().toLowerCase(),t=new Set;console.log('搜索建议: 查询"'.concat(r,'"'));let o=!1;try{console.log("尝试使用RPC函数search_ingredients_and_seasonings");let{data:e,error:a}=await n.rpc("search_ingredients_and_seasonings",{search_term:r});a?console.error("SQL RPC搜索出错:",a):e&&Array.isArray(e)&&(e.forEach(e=>{e&&"string"==typeof e&&t.add(e)}),console.log("SQL RPC搜索返回".concat(e.length,"个结果")),o=t.size>0)}catch(e){console.error("SQL RPC函数调用异常:",e)}if(!o){console.log("RPC函数调用失败，尝试使用直接的SQL查询");try{let e="\n          WITH all_items AS (\n            -- 从食材中提取\n            SELECT name FROM (\n              SELECT DISTINCT jsonb_path_query(食材::jsonb, '$[*].名称') AS name \n              FROM \"CHrecipes\" \n              WHERE 食材::text ILIKE '%".concat(r,"%'\n              LIMIT 50\n            ) AS ingredients\n            WHERE name::text ILIKE '%").concat(r,"%'\n            \n            UNION\n            \n            -- 从调料中提取\n            SELECT name FROM (\n              SELECT DISTINCT jsonb_path_query(调料::jsonb, '$[*].名称') AS name \n              FROM \"CHrecipes\" \n              WHERE 调料::text ILIKE '%").concat(r,"%'\n              LIMIT 50\n            ) AS seasonings\n            WHERE name::text ILIKE '%").concat(r,"%'\n            \n            UNION\n            \n            -- 从菜名中提取\n            SELECT 菜名 AS name \n            FROM \"CHrecipes\" \n            WHERE 菜名 ILIKE '%").concat(r,"%'\n            LIMIT 20\n          )\n          \n          SELECT DISTINCT name::text\n          FROM all_items\n          WHERE name IS NOT NULL\n          LIMIT 30\n        "),{data:o,error:a}=await n.rpc("exec_sql",{sql_query:e});a?console.error("执行SQL查询出错:",a):o&&Array.isArray(o)&&(o.forEach(e=>{e&&e.name&&"string"==typeof e.name&&t.add(e.name)}),console.log("SQL查询返回".concat(o.length,"个结果")))}catch(e){console.error("执行SQL查询异常:",e)}}if(t.size<5){console.log("回退到分别查询食材、调料和菜名");try{let{data:e,error:o}=await n.from("CHrecipes").select("食材").ilike("食材::text","%".concat(r,"%")).limit(20);o?console.error("搜索食材时出错:",o):e&&Array.isArray(e)&&(e.forEach(e=>{e&&e.食材&&Array.isArray(e.食材)&&e.食材.forEach(e=>{e&&e.名称&&"string"==typeof e.名称&&e.名称.toLowerCase().includes(r)&&t.add(e.名称)})}),console.log("食材搜索返回".concat(e.length,"个结果")))}catch(e){console.error("食材搜索异常:",e)}try{let{data:e,error:o}=await n.from("CHrecipes").select("调料").ilike("调料::text","%".concat(r,"%")).limit(20);o?console.error("搜索调料时出错:",o):e&&Array.isArray(e)&&(e.forEach(e=>{e&&e.调料&&Array.isArray(e.调料)&&e.调料.forEach(e=>{e&&e.名称&&"string"==typeof e.名称&&e.名称.toLowerCase().includes(r)&&t.add(e.名称)})}),console.log("调料搜索返回".concat(e.length,"个结果")))}catch(e){console.error("调料搜索异常:",e)}try{let{data:e,error:o}=await n.from("CHrecipes").select("菜名").ilike("菜名","%".concat(r,"%")).limit(10);o?console.error("搜索菜名时出错:",o):e&&Array.isArray(e)&&(e.forEach(e=>{e&&e.菜名&&"string"==typeof e.菜名&&t.add(e.菜名)}),console.log("菜名搜索返回".concat(e.length,"个结果")))}catch(e){console.error("菜名搜索异常:",e)}}let a=Array.from(t).sort((e,t)=>{let n=e.toLowerCase(),o=t.toLowerCase();return n===r&&o!==r?-1:o===r&&n!==r?1:n.startsWith(r)&&!o.startsWith(r)?-1:o.startsWith(r)&&!n.startsWith(r)?1:n.includes(r)&&!o.includes(r)?-1:o.includes(r)&&!n.includes(r)?1:e.length-t.length});if(console.log("找到".concat(a.length,"个建议")),0===a.length)return["".concat(e),"".concat(e,"料理"),"".concat(e,"做法"),"家常".concat(e)];return a.slice(0,10)}catch(e){return console.error("获取关键词建议失败:",e),[]}}function i(e,r){if(!r.trim())return e;let t=function(e){if(!e)return[];let r=e.trim();for(let e of[" ",",","，",";","；"])" "!==e&&(r=r.split(e).join(" "));return r.split(" ").map(e=>e.trim()).filter(e=>e.length>0)}(e),n=r.trim().toLowerCase();return t.some(e=>e.toLowerCase()===n)?e:e.trim()?"".concat(e.trim()," ").concat(r.trim()):r.trim()}n=(0,o.eI)(s,c)}},function(e){e.O(0,[410,115,69,744],function(){return e(e.s=2027)}),_N_E=e.O()}]);