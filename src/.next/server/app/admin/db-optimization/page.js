(()=>{var e={};e.id=35,e.ids=[35],e.modules={7849:e=>{"use strict";e.exports=require("next/dist/client/components/action-async-storage.external")},2934:e=>{"use strict";e.exports=require("next/dist/client/components/action-async-storage.external.js")},5403:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external")},4580:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external.js")},4749:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external")},5869:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},4300:e=>{"use strict";e.exports=require("buffer")},6113:e=>{"use strict";e.exports=require("crypto")},2361:e=>{"use strict";e.exports=require("events")},3685:e=>{"use strict";e.exports=require("http")},5687:e=>{"use strict";e.exports=require("https")},1808:e=>{"use strict";e.exports=require("net")},5477:e=>{"use strict";e.exports=require("punycode")},2781:e=>{"use strict";e.exports=require("stream")},4404:e=>{"use strict";e.exports=require("tls")},7310:e=>{"use strict";e.exports=require("url")},9796:e=>{"use strict";e.exports=require("zlib")},3555:(e,s,r)=>{"use strict";r.r(s),r.d(s,{GlobalError:()=>n.a,__next_app__:()=>u,originalPathname:()=>m,pages:()=>d,routeModule:()=>p,tree:()=>l});var t=r(7),i=r(8533),a=r(9377),n=r.n(a),c=r(9799),o={};for(let e in c)0>["default","tree","pages","GlobalError","originalPathname","__next_app__","routeModule"].indexOf(e)&&(o[e]=()=>c[e]);r.d(s,o);let l=["",{children:["admin",{children:["db-optimization",{children:["__PAGE__",{},{page:[()=>Promise.resolve().then(r.bind(r,7241)),"D:\\test\\Cursor\\What_to_eat_Web\\src\\app\\admin\\db-optimization\\page.tsx"]}]},{}]},{}]},{layout:[()=>Promise.resolve().then(r.bind(r,5421)),"D:\\test\\Cursor\\What_to_eat_Web\\src\\app\\layout.tsx"],error:[()=>Promise.resolve().then(r.bind(r,3015)),"D:\\test\\Cursor\\What_to_eat_Web\\src\\app\\error.tsx"],"not-found":[()=>Promise.resolve().then(r.bind(r,7832)),"D:\\test\\Cursor\\What_to_eat_Web\\src\\app\\not-found.tsx"]}],d=["D:\\test\\Cursor\\What_to_eat_Web\\src\\app\\admin\\db-optimization\\page.tsx"],m="/admin/db-optimization/page",u={require:r,loadChunk:()=>Promise.resolve()},p=new t.AppPageRouteModule({definition:{kind:i.x.APP_PAGE,page:"/admin/db-optimization/page",pathname:"/admin/db-optimization",bundlePath:"",filename:"",appPaths:[]},userland:{loaderTree:l}})},3810:(e,s,r)=>{Promise.resolve().then(r.bind(r,5846))},6834:(e,s,r)=>{"use strict";r.d(s,{Z:()=>d});var t=r(7580);/**
 * @license lucide-react v0.484.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let i=e=>e.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase(),a=e=>e.replace(/^([A-Z])|[\s-_]+(\w)/g,(e,s,r)=>r?r.toUpperCase():s.toLowerCase()),n=e=>{let s=a(e);return s.charAt(0).toUpperCase()+s.slice(1)},c=(...e)=>e.filter((e,s,r)=>!!e&&""!==e.trim()&&r.indexOf(e)===s).join(" ").trim();/**
 * @license lucide-react v0.484.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */var o={xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"};/**
 * @license lucide-react v0.484.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let l=(0,t.forwardRef)(({color:e="currentColor",size:s=24,strokeWidth:r=2,absoluteStrokeWidth:i,className:a="",children:n,iconNode:l,...d},m)=>(0,t.createElement)("svg",{ref:m,...o,width:s,height:s,stroke:e,strokeWidth:i?24*Number(r)/Number(s):r,className:c("lucide",a),...d},[...l.map(([e,s])=>(0,t.createElement)(e,s)),...Array.isArray(n)?n:[n]])),d=(e,s)=>{let r=(0,t.forwardRef)(({className:r,...a},o)=>(0,t.createElement)(l,{ref:o,iconNode:s,className:c(`lucide-${i(n(e))}`,`lucide-${e}`,r),...a}));return r.displayName=n(e),r}},7540:(e,s,r)=>{"use strict";r.d(s,{Z:()=>t});let t=(0,r(6834).Z)("clock",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["polyline",{points:"12 6 12 12 16 14",key:"68esgv"}]])},8199:(e,s,r)=>{"use strict";r.d(s,{Z:()=>t});let t=(0,r(6834).Z)("database",[["ellipse",{cx:"12",cy:"5",rx:"9",ry:"3",key:"msslwz"}],["path",{d:"M3 5V19A9 3 0 0 0 21 19V5",key:"1wlel7"}],["path",{d:"M3 12A9 3 0 0 0 21 12",key:"mv7ke4"}]])},5846:(e,s,r)=>{"use strict";let t;r.r(s),r.d(s,{default:()=>_});var i=r(4714),a=r(7580),n=r(9872),c=r(7540),o=r(6834);let l=(0,o.Z)("refresh-cw",[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8",key:"v9h5vc"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16",key:"3uifl3"}],["path",{d:"M8 16H3v5",key:"1cv678"}]]),d=(0,o.Z)("circle-check-big",[["path",{d:"M21.801 10A10 10 0 1 1 17 3.335",key:"yps3ct"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]]),m=(0,o.Z)("circle-x",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m15 9-6 6",key:"1uzhvr"}],["path",{d:"m9 9 6 6",key:"z0biqf"}]]),u=(0,o.Z)("circle-alert",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["line",{x1:"12",x2:"12",y1:"8",y2:"12",key:"1pkeuh"}],["line",{x1:"12",x2:"12.01",y1:"16",y2:"16",key:"4dfq90"}]]),p=(0,o.Z)("chevron-left",[["path",{d:"m15 18-6-6 6-6",key:"1wnfg3"}]]);var x=r(8199);let g=(0,o.Z)("circle-play",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["polygon",{points:"10 8 16 12 10 16 10 8",key:"1cimsy"}]]);r(8384),process.env.NEXT_PUBLIC_SUPABASE_URL,process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY,console.log("静态构建环境检测到，使用模拟的Supabase客户端在db-optimization中"),t={rpc:()=>({execute:async()=>({data:[],error:null})}),from:()=>({select:()=>({execute:async()=>({data:[],error:null})})})};let h=[{name:"idx_recipe_name",description:"菜谱名称文本搜索索引",tableName:"CHrecipes",sql:'CREATE INDEX IF NOT EXISTS idx_recipe_name ON "CHrecipes" USING gin (to_tsvector(\'chinese\', "name"));'},{name:"idx_recipe_description",description:"菜谱描述文本搜索索引",tableName:"CHrecipes",sql:'CREATE INDEX IF NOT EXISTS idx_recipe_description ON "CHrecipes" USING gin (to_tsvector(\'chinese\', "description"));'},{name:"idx_recipe_ingredients",description:"食材JSONB索引",tableName:"CHrecipes",sql:'CREATE INDEX IF NOT EXISTS idx_recipe_ingredients ON "CHrecipes" USING gin ("ingredients");'},{name:"idx_recipe_seasonings",description:"调料JSONB索引",tableName:"CHrecipes",sql:'CREATE INDEX IF NOT EXISTS idx_recipe_seasonings ON "CHrecipes" USING gin ("seasonings");'},{name:"idx_recipe_flavors",description:"口味特点索引",tableName:"CHrecipes",sql:'CREATE INDEX IF NOT EXISTS idx_recipe_flavors ON "CHrecipes" USING gin ("flavors");'},{name:"idx_recipe_cuisine",description:"菜系索引",tableName:"CHrecipes",sql:'CREATE INDEX IF NOT EXISTS idx_recipe_cuisine ON "CHrecipes" ("cuisine");'},{name:"idx_recipe_difficulty",description:"难度索引",tableName:"CHrecipes",sql:'CREATE INDEX IF NOT EXISTS idx_recipe_difficulty ON "CHrecipes" ("difficulty");'},{name:"idx_recipe_cookingTime",description:"烹饪时间索引",tableName:"CHrecipes",sql:'CREATE INDEX IF NOT EXISTS idx_recipe_cookingTime ON "CHrecipes" ("cookingTime");'},{name:"idx_recipe_cookingMethods",description:"烹饪方法索引",tableName:"CHrecipes",sql:'CREATE INDEX IF NOT EXISTS idx_recipe_cookingMethods ON "CHrecipes" USING gin ("cookingMethods");'},{name:"idx_recipe_dietaryRestrictions",description:"饮食限制索引",tableName:"CHrecipes",sql:'CREATE INDEX IF NOT EXISTS idx_recipe_dietaryRestrictions ON "CHrecipes" USING gin ("dietaryRestrictions");'}];async function y(){console.log("开始创建所有索引...");let e=!1,s=[];for(let r of h){console.log(`创建索引: ${r.name}`);let i={...r,runStatus:"running"};s.push(i);try{let{error:s}=await t.rpc("run_sql",{sql_query:r.sql});s?(console.error(`创建索引 ${r.name} 失败:`,s.message),i.runStatus="error",i.errorMessage=s.message,e=!0):(console.log(`索引 ${r.name} 创建成功`),i.runStatus="success")}catch(s){console.error(`创建索引 ${r.name} 发生错误:`,s),i.runStatus="error",i.errorMessage=s instanceof Error?s.message:String(s),e=!0}}return{success:!e,results:s,error:e?"部分索引创建失败，请查看详情":void 0}}async function N(e){let s=h.find(s=>s.name===e);if(!s)return{success:!1,error:`索引 ${e} 未找到定义`};console.log(`创建索引: ${s.name}`);try{let{error:e}=await t.rpc("run_sql",{sql_query:s.sql});if(e)return console.error(`创建索引 ${s.name} 失败:`,e.message),{success:!1,error:e.message};return console.log(`索引 ${s.name} 创建成功`),{success:!0}}catch(e){return console.error(`创建索引 ${s.name} 发生错误:`,e),{success:!1,error:e instanceof Error?e.message:String(e)}}}async function f(){console.log("检查索引状态...");try{let e=`
      SELECT
        i.indexname AS index_name,
        i.indexdef AS index_definition
      FROM
        pg_indexes i
      WHERE
        i.schemaname = 'public' AND
        i.tablename = 'CHrecipes';
    `,{data:s,error:r}=await t.rpc("run_sql",{sql_query:e});if(r)return console.error("检查索引状态失败:",r.message),{success:!1,error:r.message};let i=s.map(e=>e.index_name),a=h.map(e=>({name:e.name,exists:i.includes(e.name)}));return console.log("索引状态检查完成"),{success:!0,indexes:a}}catch(e){return console.error("检查索引状态发生错误:",e),{success:!1,error:e instanceof Error?e.message:String(e)}}}async function b(){console.log("开始执行ANALYZE命令...");try{let{error:e}=await t.rpc("run_sql",{sql_query:'ANALYZE "CHrecipes";'});if(e)return console.error("执行ANALYZE命令失败:",e.message),{success:!1,error:e.message};return console.log("ANALYZE命令执行成功"),{success:!0}}catch(e){return console.error("执行ANALYZE命令发生错误:",e),{success:!1,error:e instanceof Error?e.message:String(e)}}}function _(){let[e,s]=(0,a.useState)(h.map(e=>({name:e.name,description:e.description,status:"pending"}))),[r,t]=(0,a.useState)("pending"),[o,_]=(0,a.useState)(null),[E,v]=(0,a.useState)([]),[j,S]=(0,a.useState)(!1),[C,A]=(0,a.useState)([]),[q,k]=(0,a.useState)(!1),w=e=>{let s=new Date().toLocaleTimeString();v(r=>[...r,`[${s}] ${e}`])},I=async()=>{k(!0),w("正在检查数据库索引状态...");try{let r=await f();if(r.success&&r.indexes){A(r.indexes),w(`索引检查完成，共 ${r.indexes.length} 个索引`);let t=[...e];r.indexes.forEach(({name:e,exists:s})=>{let r=t.findIndex(s=>s.name===e);-1!==r&&(t[r].status=s?"success":"pending")}),s(t)}else w(`索引检查失败: ${r.error||"未知错误"}`)}catch(e){w(`索引检查发生错误: ${e instanceof Error?e.message:String(e)}`)}finally{k(!1)}},T=async r=>{let t=e.findIndex(e=>e.name===r);if(-1===t)return;let i=[...e];i[t].status="running",s(i),w(`开始创建索引: ${r}`);try{let e=await N(r),a=[...i];e.success?(a[t].status="success",w(`索引 ${r} 创建成功`)):(a[t].status="error",a[t].error=e.error,w(`索引 ${r} 创建失败: ${e.error}`)),s(a)}catch(a){let e=[...i];e[t].status="error",e[t].error=a instanceof Error?a.message:String(a),s(e),w(`创建索引 ${r} 时发生错误: ${e[t].error}`)}},$=async()=>{S(!0),s(e.map(e=>({...e,status:"running"}))),w("开始创建所有索引...");try{let e=await y(),r=e.results.map((e,s)=>({name:e.name,description:e.description,status:e.runStatus||"pending",error:e.errorMessage}));s(r),e.success?w("所有索引创建成功"):w(`部分索引创建失败: ${e.error||"未知错误"}`)}catch(e){w(`创建索引时发生错误: ${e instanceof Error?e.message:String(e)}`)}finally{S(!1)}},O=async()=>{t("running"),_(null),w("开始执行ANALYZE命令优化数据库统计信息...");try{let e=await b();e.success?(t("success"),w("ANALYZE命令执行成功")):(t("error"),_(e.error||null),w(`ANALYZE命令执行失败: ${e.error}`))}catch(s){t("error");let e=s instanceof Error?s.message:String(s);_(e),w(`执行ANALYZE命令时发生错误: ${e}`)}},Z=e=>{switch(e){case"pending":return i.jsx(c.Z,{size:18,className:"text-gray-400"});case"running":return i.jsx(l,{size:18,className:"text-blue-500 animate-spin"});case"success":return i.jsx(d,{size:18,className:"text-green-500"});case"error":return i.jsx(m,{size:18,className:"text-red-500"});default:return i.jsx(u,{size:18,className:"text-gray-400"})}};return(0,a.useEffect)(()=>{I()},[]),(0,i.jsxs)("div",{className:"container mx-auto px-4 py-8 max-w-6xl",children:[i.jsx("div",{className:"flex items-center mb-6",children:(0,i.jsxs)(n.default,{href:"/admin",className:"flex items-center text-gray-600 hover:text-gray-900",children:[i.jsx(p,{size:20,className:"mr-1"}),i.jsx("span",{children:"返回管理面板"})]})}),(0,i.jsxs)("div",{className:"flex items-center mb-6",children:[i.jsx(x.Z,{size:24,className:"mr-2 text-blue-600"}),i.jsx("h1",{className:"text-2xl font-bold",children:"数据库优化"})]}),(0,i.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[i.jsx("div",{className:"lg:col-span-2",children:(0,i.jsxs)("div",{className:"bg-white rounded-lg shadow-md p-6",children:[(0,i.jsxs)("div",{className:"flex justify-between items-center mb-4",children:[i.jsx("h2",{className:"text-lg font-semibold",children:"索引优化任务"}),(0,i.jsxs)("div",{className:"flex gap-2",children:[(0,i.jsxs)("button",{onClick:I,disabled:q,className:"px-3 py-1.5 bg-gray-100 hover:bg-gray-200 rounded-md text-sm font-medium flex items-center disabled:opacity-50",children:[i.jsx(l,{size:16,className:`mr-1 ${q?"animate-spin":""}`}),"检查状态"]}),(0,i.jsxs)("button",{onClick:$,disabled:j,className:"px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded-md text-sm font-medium flex items-center disabled:opacity-50",children:[i.jsx(g,{size:16,className:"mr-1"}),"执行全部"]})]})]}),i.jsx("div",{className:"overflow-hidden rounded-md border border-gray-200",children:(0,i.jsxs)("table",{className:"min-w-full divide-y divide-gray-200",children:[i.jsx("thead",{className:"bg-gray-50",children:(0,i.jsxs)("tr",{children:[i.jsx("th",{scope:"col",className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"索引名称"}),i.jsx("th",{scope:"col",className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"描述"}),i.jsx("th",{scope:"col",className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"状态"}),i.jsx("th",{scope:"col",className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"操作"})]})}),i.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:e.map(e=>(0,i.jsxs)("tr",{children:[i.jsx("td",{className:"px-4 py-3 text-sm text-gray-900 font-mono",children:e.name}),i.jsx("td",{className:"px-4 py-3 text-sm text-gray-600",children:e.description}),i.jsx("td",{className:"px-4 py-3 text-sm",children:(0,i.jsxs)("div",{className:"flex items-center",children:[Z(e.status),(0,i.jsxs)("span",{className:"ml-2",children:["pending"===e.status&&"待执行","running"===e.status&&"执行中","success"===e.status&&"已完成","error"===e.status&&"失败"]})]})}),(0,i.jsxs)("td",{className:"px-4 py-3 text-sm",children:[i.jsx("button",{onClick:()=>T(e.name),disabled:"running"===e.status||j,className:"px-2 py-1 bg-blue-50 hover:bg-blue-100 text-blue-600 rounded-md text-xs font-medium disabled:opacity-50",children:"success"===e.status?"重新创建":"执行"}),e.error&&(0,i.jsxs)("div",{className:"mt-1 text-xs text-red-500 truncate max-w-xs",title:e.error,children:[e.error.substring(0,50),e.error.length>50?"...":""]})]})]},e.name))})]})}),(0,i.jsxs)("div",{className:"mt-6",children:[i.jsx("h3",{className:"text-md font-semibold mb-3",children:"其他优化任务"}),(0,i.jsxs)("div",{className:"bg-gray-50 rounded-md p-4 flex items-center justify-between",children:[(0,i.jsxs)("div",{children:[i.jsx("div",{className:"font-medium",children:"更新数据库统计信息 (ANALYZE)"}),i.jsx("div",{className:"text-sm text-gray-600",children:"优化查询计划，提高查询效率"})]}),(0,i.jsxs)("div",{className:"flex items-center",children:[Z(r),i.jsx("button",{onClick:O,disabled:"running"===r,className:"ml-4 px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded-md text-sm font-medium disabled:opacity-50",children:"执行"})]})]}),o&&(0,i.jsxs)("div",{className:"mt-2 text-sm text-red-500",children:["错误: ",o]})]})]})}),i.jsx("div",{className:"lg:col-span-1",children:(0,i.jsxs)("div",{className:"bg-gray-900 rounded-lg shadow-md h-full",children:[(0,i.jsxs)("div",{className:"px-4 py-3 border-b border-gray-800 flex justify-between items-center",children:[i.jsx("h3",{className:"text-gray-200 font-mono text-sm",children:"执行日志"}),i.jsx("button",{onClick:()=>v([]),className:"text-gray-400 hover:text-gray-200 text-xs",children:"清空"})]}),i.jsx("div",{className:"p-4 font-mono text-xs text-gray-300 h-[600px] overflow-y-auto",children:0===E.length?i.jsx("div",{className:"text-gray-500 italic",children:"暂无日志输出"}):E.map((e,s)=>i.jsx("div",{className:"mb-1",children:e},s))})]})})]})]})}},7241:(e,s,r)=>{"use strict";r.r(s),r.d(s,{$$typeof:()=>a,__esModule:()=>i,default:()=>n});let t=(0,r(1481).createProxy)(String.raw`D:\test\Cursor\What_to_eat_Web\src\app\admin\db-optimization\page.tsx`),{__esModule:i,$$typeof:a}=t,n=t.default}};var s=require("../../../webpack-runtime.js");s.C(e);var r=e=>s(s.s=e),t=s.X(0,[499,843,384,242],()=>r(3555));module.exports=t})();