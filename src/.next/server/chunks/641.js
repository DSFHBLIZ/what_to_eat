"use strict";exports.id=641,exports.ids=[641],exports.modules={3641:(e,r,t)=>{t.d(r,{C_:()=>c,Dq:()=>g,GS:()=>f,if:()=>p,mN:()=>y,mU:()=>l,rm:()=>h,wb:()=>d});var i=t(3030),n=t(1418),o=t(2615),s=t(3793);let a=[];function l(e){a=e}function c(e){let r=[...a];if(e.ingredients&&e.ingredients.length>0&&(r=r.filter(r=>e.ingredients.every(e=>Array.isArray(r.ingredients)&&r.ingredients.some(r=>"string"==typeof r&&r.toLowerCase().includes(e.toLowerCase()))))),e.optionalIngredients&&e.optionalIngredients.length>0&&(r=r.filter(r=>e.optionalIngredients.some(e=>Array.isArray(r.ingredients)&&r.ingredients.some(r=>"string"==typeof r&&r.toLowerCase().includes(e.toLowerCase()))))),e.flavors&&e.flavors.length>0&&(r=r.filter(r=>e.flavors.every(e=>Array.isArray(r.flavors)&&r.flavors.includes(e)))),e.difficulty&&(r=r.filter(r=>r.difficulty===e.difficulty)),e.cuisine&&(r=r.filter(r=>r.cuisine===e.cuisine)),e.cookingMethods&&e.cookingMethods.length>0&&(r=r.filter(r=>e.cookingMethods.some(e=>r.cookingMethod&&Array.isArray(r.cookingMethod)&&r.cookingMethod.includes(e)))),e.dietaryRestrictions&&e.dietaryRestrictions.length>0&&(r=r.filter(r=>e.dietaryRestrictions.some(e=>r.dietaryRestrictions&&Array.isArray(r.dietaryRestrictions)&&r.dietaryRestrictions.includes(e)))),e.searchQuery&&""!==e.searchQuery.trim()){let t=e.searchQuery.toLowerCase().trim();r=r.filter(e=>e.name.toLowerCase().includes(t)||e.description&&e.description.toLowerCase().includes(t)||Array.isArray(e.ingredients)&&e.ingredients.some(e=>"string"==typeof e&&e.toLowerCase().includes(t)))}return r}async function f(e){try{let r={};if(e.ingredients&&e.ingredients.length>0&&(r.ingredients=e.ingredients),e.optionalIngredients&&e.optionalIngredients.length>0&&(r.optionalIngredients=e.optionalIngredients),e.flavors&&e.flavors.length>0&&(r.taste=e.flavors.map(e=>e.toString())),e.difficulty&&(r.difficulty=e.difficulty),e.cuisine&&(r.cuisine=e.cuisine),e.cookingMethods&&e.cookingMethods.length>0&&(r.cookingMethod=e.cookingMethods),e.dietaryRestrictions&&e.dietaryRestrictions.length>0)for(let t of e.dietaryRestrictions)"纯素"===t?r.isVegan=!0:"清真"===t?r.isHalal=!0:"无麸质"===t&&(r.isGlutenFree=!0);if(e.searchQuery&&""!==e.searchQuery.trim()&&(r.searchQuery=e.searchQuery.trim()),r.searchQuery)return console.log(`使用搜索API查询: ${r.searchQuery}`),await (0,i.s8)(r.searchQuery);let t=i.OQ.from("CHrecipes").select("*");if(r.cuisine&&(t=t.eq("菜系",r.cuisine)),r.difficulty&&(t=t.eq("烹饪难度",r.difficulty)),r.isVegan&&(t=t.eq("是否纯素",!0)),r.isHalal&&(t=t.eq("是否清真",!0)),r.isGlutenFree&&(t=t.eq("是否无麸质",!0)),r.ingredients&&r.ingredients.length>0)for(let e of r.ingredients)t=t.filter("食材","cs",`%${e}%`);if(r.optionalIngredients&&r.optionalIngredients.length>0){let e=r.optionalIngredients.map(e=>`食材::text ilike '%${e}%' OR 调料::text ilike '%${e}%'`);e.length>0&&(t=t.or(e.join(",")))}if(r.taste&&r.taste.length>0){let e=r.taste.map(e=>`"口味特点"::jsonb @> '["${e}"]'`).join(" OR ");e&&(t=t.or(e))}if(r.cookingMethod&&r.cookingMethod.length>0){let e=r.cookingMethod.map(e=>`"烹饪技法"::jsonb @> '["${e}"]'`).join(" OR ");e&&(t=t.or(e))}console.log("使用多条件筛选API查询",r);let{data:n,error:o}=await t;if(o)throw console.error("Supabase查询出错:",o),o;if(!n||0===n.length)return console.log("没有找到匹配的菜谱"),[];console.log(`找到${n.length}个匹配的菜谱`);let a=(0,s.Ki)(n);if(e.searchQuery&&""!==e.searchQuery.trim()){let r=e.searchQuery.trim();return a.map(e=>{let t=function(e,r){if(!r)return 0;let t=0;for(let i of r.toLowerCase().trim().split(/\s+/).filter(Boolean)){if(e.name&&e.name.toLowerCase().includes(i)&&(t+=15,e.name.toLowerCase()===i?t+=5:e.name.toLowerCase().startsWith(i)&&(t+=3)),Array.isArray(e.ingredients))for(let r of e.ingredients){let e="";if("string"==typeof r?e=r.toLowerCase():"object"==typeof r&&null!==r&&(e=(r.name||r.名称||"").toLowerCase()),e&&e.includes(i)){t+=12,e===i?t+=3:e.startsWith(i)&&(t+=1);break}}if(Array.isArray(e.seasonings))for(let r of e.seasonings){let e="";if("string"==typeof r?e=r.toLowerCase():"object"==typeof r&&null!==r&&(e=(r.name||r.名称||"").toLowerCase()),e&&e.includes(i)){t+=8,e===i?t+=2:e.startsWith(i)&&(t+=1);break}}if(Array.isArray(e.cookingMethod)){for(let r of e.cookingMethod)if("string"==typeof r&&r.toLowerCase().includes(i)){t+=5,r.toLowerCase()===i&&(t+=1);break}}let r=!1;if(e.cookingSteps&&Array.isArray(e.cookingSteps)){for(let n of e.cookingSteps)if("string"==typeof n&&n.toLowerCase().includes(i)){t+=6,r=!0;break}}if(!r&&e.steps&&Array.isArray(e.steps)){for(let r of e.steps)if("string"==typeof r&&r.toLowerCase().includes(i)){t+=6;break}}if(e.description&&e.description.toLowerCase().includes(i)&&(t+=3),e.cuisine&&e.cuisine.toLowerCase().includes(i)&&(t+=4,e.cuisine.toLowerCase()===i&&(t+=1)),Array.isArray(e.flavors)){for(let r of e.flavors)if("string"==typeof r&&r.toLowerCase().includes(i)){t+=4,r.toLowerCase()===i&&(t+=1);break}}}return console.log(`菜谱"${e.name}"的相关性得分: ${t.toFixed(2)}`),t}(e,r);return{...e,matchScore:t,matchedIngredients:u(e.ingredients,r),matchedSeasonings:u(e.seasonings,r)}}).sort((e,r)=>(r.matchScore||0)-(e.matchScore||0))}return a}catch(r){return console.error("远程筛选失败:",r),console.log("回退到本地筛选..."),c(e)}}function u(e,r){if(!e||!Array.isArray(e)||!r)return[];let t=r.toLowerCase().trim(),i=[];for(let r of e)if("string"==typeof r)r.toLowerCase().includes(t)&&i.push(r);else if("object"==typeof r&&null!==r){let e=r.name||r.名称;e&&"string"==typeof e&&e.toLowerCase().includes(t)&&i.push(e)}return i}function d(e){return(0,n.x)().find(r=>r.id===e)||null}function y(e){return!1}function g(e){return[].includes(e)}function p(e,r="",t=""){try{if(null==e)return r&&t&&console.warn(`[${r}] ${t}值为${e}，已转换为空数组`),[];if(Array.isArray(e))return e;if("string"==typeof e)try{let r=JSON.parse(e);if(Array.isArray(r))return r}catch(r){return[e]}if("object"==typeof e){if("标签"in e&&void 0!==e.标签){if(Array.isArray(e.标签))return e.标签;if("string"==typeof e.标签)return[e.标签]}if("主要口味"in e&&void 0!==e.主要口味){if(Array.isArray(e.主要口味))return e.主要口味;if("string"==typeof e.主要口味)return[e.主要口味]}}return[e]}catch(r){return console.error("safeArray转换失败",r,e),[]}}function h(e,r,t,i="unknown",n="safeArraySlice"){if(void 0===e)return(0,o.H)(i,n,TypeError("尝试对undefined值使用slice"),{arrayType:"undefined",isNull:!1,isUndefined:!0,requestedRange:`${r??"0"}-${t??"end"}`,stackTrace:Error().stack}),[];if(null===e)return(0,o.H)(i,n,TypeError("尝试对null值使用slice"),{arrayType:"null",isNull:!0,isUndefined:!1,requestedRange:`${r??"0"}-${t??"end"}`,stackTrace:Error().stack}),[];try{if(Array.isArray(e))try{return e.slice(r,t)}catch(s){return(0,o.H)(i,n,s,{errorLocation:"slice内部操作",arrayLength:e.length,requestedRange:`${r??"0"}-${t??"end"}`,stackTrace:Error().stack}),[]}return(0,o.H)(i,n,TypeError(`尝试对非数组类型(${typeof e})使用slice`),{arrayType:typeof e,objectConstructor:e.constructor?e.constructor.name:"unknown",sampleValue:String(e).substring(0,100),requestedRange:`${r??"0"}-${t??"end"}`,stackTrace:Error().stack}),[]}catch(s){return(0,o.H)(i,n,s,{arrayType:typeof e,isNull:null===e,isUndefined:void 0===e,requestedRange:`${r??"0"}-${t??"end"}`,errorName:s.name,errorMessage:s.message,stackTrace:s.stack||Error().stack}),[]}}}};